# Функционал просмотра камер в реальном времени

## Обзор

Добавлен расширенный функционал просмотра камер на главной странице Dashboard с возможностью управления воспроизведением и масштабированием.

## Возможности

### 1. Просмотр на Dashboard ✅

**Запуск просмотра:**
- Нажмите кнопку ▶️ Play на карточке камеры
- Видеопоток начнет отображаться в реальном времени

**Остановка просмотра:**
- Наведите курсор на воспроизводимое видео
- Появятся кнопки управления
- Нажмите красную кнопку ⏹️ Stop для остановки

### 2. Открытие в отдельном окне ✅

**Как открыть:**
- Запустите просмотр камеры
- Наведите курсор на видео
- Нажмите синюю кнопку 🔗 "Открыть в окне"

**Возможности отдельного окна:**
- Размер: 1280×720 пикселей
- Центрирование на экране
- Изменяемый размер (resizable)
- Независимое управление

### 3. Масштабирование ✅

**В отдельном окне доступны:**

**Кнопки масштабирования:**
- `100%` - оригинальный размер
- `150%` - увеличение в 1.5 раза
- `200%` - увеличение в 2 раза
- `300%` - увеличение в 3 раза
- `Сбросить` - возврат к 100%

**Горячие клавиши:**
- `1` - 100%
- `2` - 150%
- `3` - 200%
- `4` - 300%
- `0` - Сбросить
- `Esc` - Закрыть окно

## Интерфейс

### Dashboard карточка камеры

```
┌─────────────────────────────────┐
│                                 │
│      [Видеопоток]              │
│      или                        │
│      [▶️ Play Button]           │
│                                 │
│  (при наведении на видео)       │
│      [⏹️ Stop] [🔗 В окне]      │
│                                 │
├─────────────────────────────────┤
│ 📹 Название камеры    [Статус]  │
│ 📹 Запись  ⚡ Детекция          │
└─────────────────────────────────┘
```

### Отдельное окно

```
┌──────────────────────────────────────────┐
│ 📹 Название камеры              [✕ Закрыть] │
├──────────────────────────────────────────┤
│                                          │
│                                          │
│            [Видеопоток]                  │
│                                          │
│                                          │
├──────────────────────────────────────────┤
│ [100%] [150%] [200%] [300%] [Сбросить]  │
└──────────────────────────────────────────┘
```

## Технические детали

### Frontend (Dashboard.js)

**State управление:**
```javascript
const [isLive, setIsLive] = useState(false);
const [showFullscreen, setShowFullscreen] = useState(false);
```

**Компоненты:**
1. **Play button** - запуск просмотра
2. **Stop button** - остановка (появляется при hover)
3. **Open window button** - открытие в новом окне
4. **Video element** - отображение MJPEG потока

**Overlay controls:**
- Появляются при наведении на видео
- Полупрозрачный фон
- Плавная анимация (transition)

### Backend API

**Endpoint:**
```
GET /api/stream/{camera_id}
```

**Тип ответа:**
- `multipart/x-mixed-replace`
- MJPEG stream (Motion JPEG)

**Процесс:**
1. Получение camera из БД
2. Создание CameraRecorder
3. Захват кадров из потока (RTSP/HTTP)
4. Кодирование в JPEG
5. Отправка как MJPEG stream

### MJPEG Stream

**Формат:**
```
Content-Type: multipart/x-mixed-replace; boundary=frame

--frame
Content-Type: image/jpeg

[JPEG DATA]
--frame
Content-Type: image/jpeg

[JPEG DATA]
...
```

**Преимущества:**
- Простая реализация
- Поддержка в `<img>` тегах
- Низкая задержка
- Не требует JavaScript player

**Недостатки:**
- Больший размер по сравнению с H.264
- Нет аудио
- Высокий bandwidth для высокого FPS

## Производительность

### Одна камера:
- **Bandwidth:** ~0.5-2 MB/s (зависит от разрешения и FPS)
- **CPU:** +10-15% (кодирование JPEG)
- **RAM:** +20-30 MB

### Множество камер:
- **3 камеры:** ~1.5-6 MB/s, +30-45% CPU
- **10 камер:** ~5-20 MB/s, +100-150% CPU

### Оптимизация:
- Уменьшить FPS для preview (10-15 FPS достаточно)
- Уменьшить разрешение для preview
- Использовать substream если камера поддерживает

## Использование

### Базовый просмотр:

1. Откройте Dashboard
2. Найдите нужную камеру
3. Нажмите ▶️ Play
4. Видео начнет воспроизводиться

### Остановка:

1. Наведите курсор на видео
2. Нажмите ⏹️ Stop (красная кнопка)

### Открытие в окне:

1. Запустите просмотр
2. Наведите курсор на видео
3. Нажмите 🔗 "Открыть в окне" (синяя кнопка)
4. Используйте кнопки масштабирования

### Масштабирование:

**С кнопками:**
1. Нажмите на нужный масштаб (100%, 150%, 200%, 300%)
2. Активная кнопка подсвечена синим

**С клавиатурой:**
1. Нажмите цифру для масштаба (1, 2, 3, 4)
2. Нажмите 0 для сброса
3. Нажмите Esc для закрытия окна

## Стили и анимации

### Hover эффекты:

**Play button:**
```css
bg-white/20 → bg-white/30 (при hover)
backdrop-blur-sm
transition-colors
```

**Control buttons:**
```css
Непрозрачность: 0 → 100% (при hover на видео)
transition-opacity
```

**Video zoom:**
```css
transform: scale(X)
transition: transform 0.3s
```

### Цвета:

- **Play:** Белый полупрозрачный
- **Stop:** Красный (`bg-red-500/80`)
- **Open window:** Синий (`bg-blue-500/80`)
- **Active zoom:** Синий (`bg-blue-600/80`)

## Совместимость

### Браузеры:
- ✅ Chrome/Edge 90+
- ✅ Firefox 88+
- ✅ Safari 14+
- ✅ Opera 76+

### Устройства:
- ✅ Desktop (Windows, macOS, Linux)
- ✅ Tablet
- ⚠️ Mobile (работает, но требует больше bandwidth)

## Решение проблем

### Видео не загружается

**Причина 1:** Камера недоступна
```bash
# Проверить статус камеры
curl http://localhost:8001/api/cameras/{camera_id}
```

**Решение:** Проверить подключение камеры

**Причина 2:** Backend не запущен
```bash
# Проверить backend
supervisorctl status backend
```

**Решение:** Перезапустить backend

**Причина 3:** Высокая нагрузка
```bash
# Проверить CPU
top | grep uvicorn
```

**Решение:** Уменьшить количество просматриваемых камер

### Видео тормозит

**Причина:** Низкий bandwidth или высокая нагрузка

**Решение:**
1. Закрыть другие камеры
2. Уменьшить разрешение камеры
3. Использовать проводное подключение

### Окно не открывается

**Причина:** Блокировка popup

**Решение:**
1. Разрешить popup для сайта
2. Проверить настройки браузера

### Масштабирование не работает

**Причина:** JavaScript отключен

**Решение:**
1. Включить JavaScript в браузере
2. Обновить страницу

## API Reference

### GET /api/stream/{camera_id}

**Параметры:**
- `camera_id` - UUID камеры

**Ответ:**
- Content-Type: `multipart/x-mixed-replace; boundary=frame`
- Stream: MJPEG

**Пример:**
```javascript
<img src="${API}/stream/${camera.id}" />
```

**Ошибки:**
- `404` - Камера не найдена
- `500` - Ошибка подключения к камере

## Дополнительные функции (будущее)

### Планируется:

1. **PTZ Control** (Pan-Tilt-Zoom)
   - Управление поворотом камеры
   - Digital zoom
   - Preset позиции

2. **Snapshot**
   - Сохранение текущего кадра
   - Экспорт в JPG/PNG

3. **Multiple views**
   - 2×2, 3×3, 4×4 grid
   - Синхронное масштабирование

4. **Recording control**
   - Запуск/остановка записи
   - Создание клипов

5. **Audio support**
   - Аудио от камеры
   - Two-way audio

6. **Enhanced zoom**
   - Pinch-to-zoom (mobile)
   - Mouse wheel zoom
   - Pan при zoom

7. **Performance**
   - Адаптивный bitrate
   - WebRTC support для низкой задержки
   - Hardware acceleration

## Changelog

**v1.0 (2025-10-15)**
- ✅ Просмотр на Dashboard
- ✅ Кнопки Play/Stop
- ✅ Открытие в отдельном окне
- ✅ Масштабирование (100%, 150%, 200%, 300%)
- ✅ Горячие клавиши
- ✅ Hover controls
- ✅ Error handling
