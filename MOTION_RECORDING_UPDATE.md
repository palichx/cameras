# Обновление механизма записи движения

## Изменения в версии 2.0

### 1. Непрерывная запись при продолжающемся движении ✅

**Проблема:** Запись останавливалась после периода постзаписи, даже если движение продолжалось.

**Решение:** Обновлена логика детекции движения:

```python
if motion_detected:
    frames_since_motion = 0  # Сброс счетчика
    
    if self.motion_state == "idle":
        # Начать новую запись
        self._start_motion_recording()
    
    elif self.motion_state == "cooldown":
        # Возобновить запись если движение началось снова
        self._start_motion_recording()
    
    # Всегда записывать кадр если есть движение
    if self.motion_writer:
        self.motion_writer.write(frame)
```

**Теперь работает так:**
- Движение обнаружено → Запись начинается
- Движение продолжается → Запись продолжается **бесконечно**
- Движение прекратилось → Постзапись N секунд → Остановка
- Движение возобновилось в cooldown → Запись начинается снова

### 2. Просмотр записей в интерфейсе ✅

Добавлен встроенный видеоплеер для просмотра записей прямо в браузере.

**Возможности:**
- ▶️ Воспроизведение записей одним кликом
- ⏸️ Полный контроль воспроизведения (play/pause/seek)
- 🔊 Регулировка громкости
- 📺 Полноэкранный режим
- 📥 Скачивание видео
- ℹ️ Информация о записи (размер, длительность, дата)

**Использование:**

1. Перейдите в раздел **"Записи"**
2. Нажмите синюю кнопку **▶️ Play** на любой записи
3. Откроется диалог с видеоплеером
4. Видео начнет воспроизводиться автоматически

**Интерфейс видеоплеера:**
```
┌────────────────────────────────────────────────┐
│ [Название камеры]          [Тип записи]    [X] │
├────────────────────────────────────────────────┤
│                                                │
│              Видеоплеер                        │
│         с элементами управления                │
│                                                │
├────────────────────────────────────────────────┤
│ 📅 Дата и время           💾 Размер файла      │
│ ⏱️ Длительность            [Скачать]           │
└────────────────────────────────────────────────┘
```

## Технические детали

### Логика состояний записи

```
┌─────────┐
│  IDLE   │ ← Ожидание движения, буфер заполняется
└────┬────┘
     │ Motion detected
     ▼
┌──────────┐
│RECORDING │ ← Запись идет, пока есть движение
└────┬─────┘
     │ No motion for post_recording_seconds
     ▼
┌──────────┐
│ COOLDOWN │ ← Задержка перед новым событием
└────┬─────┘
     │ Cooldown expired
     ▼
┌─────────┐
│  IDLE   │
└─────────┘

Особый случай:
COOLDOWN + Motion detected → RECORDING (немедленный переход)
```

### Изменения в коде

**backend/server.py:**
- Обновлена логика в `_process_frames()` для RTSP
- Обновлена логика в `_record_http_mjpeg()` для HTTP MJPEG
- Обновлена логика в `_record_http_snapshot()` для HTTP Snapshot
- Добавлена обработка возобновления записи из состояния cooldown

**frontend/src/pages/Recordings.js:**
- Добавлен state `playingRecording` и `showPlayer`
- Добавлен компонент `Dialog` с видеоплеером
- Добавлена функция `handlePlay(recording)`
- Добавлена кнопка Play для каждой записи
- Добавлено отображение метаданных в плеере

### API Endpoints

**Получить видеофайл:**
```
GET /api/recordings/{recording_id}
Response: video/mp4 (binary stream)
```

**Использование в HTML5 video:**
```html
<video controls>
  <source src="${API}/recordings/{recording_id}" type="video/mp4" />
</video>
```

## Примеры использования

### Пример 1: Длительное событие
```
Движение обнаружено: 10:00:00
├─ Предзапись: 5 сек (09:59:55 - 10:00:00)
├─ Движение: 2 минуты (10:00:00 - 10:02:00)
└─ Постзапись: 5 сек (10:02:00 - 10:02:05)

Итого: 2 минуты 10 секунд в одном файле
```

### Пример 2: Прерывистое движение
```
Движение #1: 10:00:00 - 10:00:10 (10 сек)
├─ Постзапись: 5 сек
└─ Cooldown: 2 сек

Движение #2: 10:00:15 (в период cooldown)
└─ Запись возобновляется БЕЗ разрыва!

Итого: Одно непрерывное видео вместо двух фрагментов
```

### Пример 3: Просмотр записи
```bash
# 1. Получить список записей
curl http://localhost:8001/api/recordings

# 2. Воспроизвести в браузере
# Открыть: https://your-app.com/recordings
# Нажать кнопку Play на нужной записи

# 3. Скачать файл
curl http://localhost:8001/api/recordings/{id} -o recording.mp4
```

## Производительность

### Потребление ресурсов при просмотре:
- **RAM:** ~50-100 MB на открытый плеер
- **Network:** Зависит от размера файла (обычно 1-10 MB/мин)
- **CPU:** Минимальное (декодирование в браузере)

### Оптимизация:
- Видео передается через streaming (не загружается целиком)
- Браузер кеширует просмотренные фрагменты
- Поддержка seek (перемотка) без перезагрузки

## Совместимость

**Браузеры с поддержкой:**
- ✅ Chrome/Edge 90+
- ✅ Firefox 88+
- ✅ Safari 14+
- ✅ Opera 76+

**Форматы видео:**
- ✅ MP4 (H.264 + AAC)
- ✅ WebM (в будущих версиях)

## Решение проблем

### Видео не воспроизводится
**Причина:** Неподдерживаемый кодек
**Решение:** Используется стандартный H.264 кодек

### Запись не останавливается
**Причина:** Движение детектируется постоянно
**Решение:** 
- Уменьшить чувствительность (`motion_sensitivity`)
- Настроить зоны детекции (`detection_zones`)
- Увеличить постзапись для объединения событий

### Много мелких файлов
**Причина:** Маленький cooldown период
**Решение:** Увеличить `motion_cooldown_seconds` до 3-5 секунд

### Пропущено начало события
**Причина:** Недостаточная предзапись
**Решение:** Увеличить `pre_recording_seconds` до 7-10 секунд

## Changelog

**2.0.1 (2025-10-14)**
- ✅ Исправлена логика непрерывной записи при продолжающемся движении
- ✅ Добавлен встроенный видеоплеер в интерфейс
- ✅ Добавлена поддержка возобновления записи из cooldown
- ✅ Улучшено логирование событий детекции

**2.0.0 (2025-10-14)**
- ✅ Реализована предзапись с циклическим буфером
- ✅ Реализована постзапись
- ✅ Добавлен cooldown между событиями
- ✅ Настраиваемые параметры для каждой камеры

## Дальнейшие улучшения

**Планируется:**
- 🔄 Миниатюры для записей (thumbnails)
- 🔄 Временная шкала событий (timeline)
- 🔄 Экспорт множества записей в один файл
- 🔄 Поиск по времени и дате
- 🔄 Фильтрация по длительности записи
- 🔄 Пакетное скачивание записей
