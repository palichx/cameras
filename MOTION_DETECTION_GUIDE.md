# Руководство по детекции движения с пре/постзаписью

## Обзор функционала

Система видеонаблюдения теперь поддерживает улучшенную детекцию движения с функциями предзаписи и постзаписи. Это позволяет захватывать события до и после обнаружения движения, обеспечивая полный контекст происходящего.

## Как это работает

### 1. Предзапись (Pre-recording)
- Система постоянно держит в памяти буфер последних N секунд видео
- При обнаружении движения эти кадры сохраняются в начало видеофайла
- Позволяет увидеть что происходило **до** срабатывания детекции

### 2. Запись движения
- Продолжается пока детектируется движение
- Все кадры с движением записываются в файл

### 3. Постзапись (Post-recording)
- После окончания движения запись продолжается еще N секунд
- Позволяет увидеть что произошло **после** окончания движения

### 4. Задержка между событиями (Cooldown)
- Предотвращает создание множества мелких файлов
- Если движение возобновляется в течение задержки, запись не прерывается
- Объединяет близкие события движения в один файл

## Настройка параметров

### Через Web-интерфейс

1. Перейдите в раздел **Камеры**
2. Нажмите **Добавить камеру** или откройте существующую камеру
3. Включите **Детекция движения**
4. Настройте параметры:

   - **Предзапись (сек)**: 0-30 секунд (по умолчанию 5)
     - Рекомендуется: 3-10 секунд
     - Большие значения требуют больше памяти

   - **Постзапись (сек)**: 0-60 секунд (по умолчанию 5)
     - Рекомендуется: 5-15 секунд
     - Зависит от типа сцены

   - **Задержка (сек)**: 0-10 секунд (по умолчанию 2)
     - Рекомендуется: 2-5 секунд
     - Предотвращает фрагментацию записей

### Через API

```bash
curl -X POST http://localhost:8001/api/cameras \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Камера с настроенной детекцией",
    "stream_url": "rtsp://camera.example.com/stream",
    "motion_detection": true,
    "motion_sensitivity": 0.7,
    "pre_recording_seconds": 10.0,
    "post_recording_seconds": 8.0,
    "motion_cooldown_seconds": 3.0
  }'
```

## Примеры использования

### Пример 1: Охрана входа
```
Предзапись: 5 сек
Постзапись: 10 сек
Задержка: 3 сек
Чувствительность: 0.6
```
Позволяет увидеть кто подходил к двери и что делал после входа.

### Пример 2: Мониторинг парковки
```
Предзапись: 3 сек
Постзапись: 5 сек
Задержка: 5 сек
Чувствительность: 0.5
```
Захватывает подъезд машины и её парковку полностью.

### Пример 3: Чувствительная зона
```
Предзапись: 10 сек
Постзапись: 15 сек
Задержка: 2 сек
Чувствительность: 0.8
```
Максимальный контекст для важных зон.

## Технические детали

### Формат записи
- Файлы сохраняются в формате MP4
- Название: `motion_YYYYMMDD_HHMMSS.mp4`
- Расположение: `/recordings/{camera_id}/`

### Структура записи
```
[Предзапись: 5 сек] → [Движение: X сек] → [Постзапись: 5 сек]
```

### Буфер предзаписи
- Хранится в оперативной памяти
- Размер зависит от FPS камеры и настройки предзаписи
- Пример: 20 FPS × 10 сек = 200 кадров в буфере

### Состояния детекции
1. **idle** - Ожидание движения, буфер заполняется
2. **recording** - Движение обнаружено, идёт запись
3. **cooldown** - Движение закончилось, ожидание перед новым событием

## Оптимизация

### Для экономии хранилища
- Уменьшите предзапись и постзапись
- Увеличьте задержку между событиями
- Снизьте чувствительность

### Для максимальной детализации
- Увеличьте предзапись и постзапись
- Уменьшите задержку
- Повысьте чувствительность

### Рекомендации по памяти
- Каждая секунда предзаписи ≈ 1-2 МБ RAM (зависит от разрешения)
- Для 10 камер с предзаписью 5 сек ≈ 50-100 МБ RAM
- Оптимальная предзапись: 3-10 секунд

## Решение проблем

### Слишком много мелких файлов
**Решение**: Увеличьте задержку между событиями (cooldown)

### Пропущено начало события
**Решение**: Увеличьте предзапись

### Обрывается слишком рано
**Решение**: Увеличьте постзапись

### Высокое использование памяти
**Решение**: Уменьшите предзапись или количество камер

### Ложные срабатывания
**Решение**: Уменьшите чувствительность или настройте зоны детекции

## API Endpoints

### Получить параметры камеры
```bash
GET /api/cameras/{camera_id}
```

### Обновить параметры детекции
```bash
PUT /api/cameras/{camera_id}
{
  "pre_recording_seconds": 7.0,
  "post_recording_seconds": 10.0,
  "motion_cooldown_seconds": 3.0
}
```

### Получить записи с движением
```bash
GET /api/recordings?recording_type=motion
```

## Логирование

Система логирует следующие события:
- Начало записи движения с количеством предзаписанных кадров
- Окончание записи движения
- Переход в режим cooldown
- Готовность к новой детекции

Просмотр логов:
```bash
tail -f /var/log/supervisor/backend.out.log | grep -i motion
```
